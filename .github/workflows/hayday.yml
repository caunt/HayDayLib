name: HayDay

on:
  workflow_dispatch:
    inputs:
      apk_url:
        description: 'Direct download URL for the APK to install'
        required: true
        type: string

jobs:
  dump:
    runs-on: macos-latest
    env:
      APK_URL: ${{ inputs.apk_url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download package
        run: curl -L "$APK_URL" -o app-package.bin

      - name: Prepare APK
        id: prepare
        run: bash ./scripts/prepare-apk.sh

      - name: Launch emulator and install APK
        uses: ReactiveCircus/android-emulator-runner@v2
        with:
          api-level: 34
          arch: arm64-v8a
          target: google_apis
          profile: pixel_7_pro
          script: PACKAGE_ID=${{ steps.prepare.outputs.package-id }} INSTALL_MODE=${{ steps.prepare.outputs.install-mode }} ./scripts/install-apk.sh

      - name: Upload verbose artifacts
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: verbose
          path: artifacts
          
      - name: Upload libg artifacts
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: libg
          path: artifacts/libg
